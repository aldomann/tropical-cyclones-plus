---
title: "Análisis de la posición y distancia recorrida de los huracanes"
author: "Alfredo Hernández"
output:
  pdf_document: 
    fig_height: 3.5
    toc: yes
    toc_depth: 2
  html_document:
    df_print: paged
  html_notebook: default
---

```{r message=FALSE, warning=FALSE, include=FALSE}
# Libraries ------------------------------------------------
library(measurements) # Convert units

# Source base code -----------------------------------------
source("geographic_base.R")
load("geographic_analysis.RData")
```

\newpage
# Mapa de las trayectorias

```{r warning=FALSE}
map_region_hurrs(storms.natl, coords.natl.map, coords.natl, steps = c(20, 10), xtra.lims = c(3,2)) + theme_bw() 
map_region_hurrs(storms.epac, coords.epac.map, coords.epac, steps = c(10, 10), xtra.lims = c(3,2)) + theme_bw()
```

\newpage
# Análisis de la distancia

## Midiendo las distancias
Lo hacemos usando la fórmula de Haversine:
```{r}
haversine_distance <- function(lat1, lat2, lon1, lon2) {
	earth.radius = 6371000

	lat1 = lat1 * (pi/180)
	lat2 = lat2 * (pi/180)
	lon1 = lon1 * (pi/180)
	lon2 = lon2 * (pi/180)
	delta.lat = lat2 - lat1
	delta.lon = lon2 - lon1

	a <- sin(delta.lat/2) * sin(delta.lat/2) + cos(lat1) * cos(lat2) * sin(delta.lon/2) * sin(delta.lon/2)
	c <- 2 * atan2(sqrt(a), sqrt(1-a))

	return(earth.radius * c)
}
```


```{r}
storms.tracks <- storms.all %>%
	group_by(storm.id) %>%
	mutate(distance = haversine_distance(lat, lag(lat), long, lag(long))) %>%
	mutate(distance = ifelse(is.na(distance), 0, distance)) %>%
	summarise(first.lat = first(lat), last.lat = last(lat),
						first.long = first(long), last.long = last(long),
						distance = sum(distance))
```

## Huracanes con recorrido más largo
Estos resultados habría que compararlos con los de [http://www.aoml.noaa.gov/hrd/tcfaq/E7.html](http://www.aoml.noaa.gov/hrd/tcfaq/E7.html)
```{r}
storms.joint %>%
	group_by(basin) %>%
	summarise(dist.mean = mean(distance))

get_longest_paths("NATL")
get_longest_paths("EPAC")
```

## Scatterplot of distance vs duration

### Todas las tormentas
```{r}
plot_distance_scatterplot("NATL") + theme_bw()
plot_distance_scatterplot("EPAC") + theme_bw()
```

### Developing systems
```{r}
plot_distance_scatterplot("NATL", 33) + theme_bw()
plot_distance_scatterplot("EPAC", 33) + theme_bw()
```

Sobretodo en los developing systems (eliminando tormentas pequeñas), parece bastante claro que la velocidad de avance del huracán es superior para los años calientes.

<!-- \newpage -->
# Análisis de posición inicial y final

En los gráficos (no he puesto el continente de fondo) tenemos básicamente un scatterplot de la posición inicial y final (separado por años calientes y fríos), además he hecho que la transparencia de los puntos así como el tamaño dependan de la distancia recorrida por los huracanes.

## North Atlantic

### Todas las tormentas (NATL)
```{r}
plot_positions("NATL", "first") + scale_x_continuous( limits = c(-115,10), expand = c(0,0) ) + scale_y_continuous( limits = c(0,75), expand = c(0,0) ) + theme_bw()
plot_positions("NATL", "last") + scale_x_continuous( limits = c(-115,10), expand = c(0,0) ) + scale_y_continuous( limits = c(0,75), expand = c(0,0) ) + theme_bw()
```

### Developing systems (NATL)
```{r}
plot_positions("NATL", "first", 33) + scale_x_continuous( limits = c(-115,10), expand = c(0,0) ) + scale_y_continuous( limits = c(0,75), expand = c(0,0) ) + theme_bw()
plot_positions("NATL", "last", 33) + scale_x_continuous( limits = c(-115,10), expand = c(0,0) ) + scale_y_continuous( limits = c(0,75), expand = c(0,0) ) + theme_bw()
```

\newpage
## East Pacific

### Todas las tormentas (EPAC)
```{r}
plot_positions("EPAC", "first") + scale_x_continuous( limits = c(-160,-80), expand = c(0,0) ) + scale_y_continuous( limits = c(5,45), expand = c(0,0) ) + theme_bw()
plot_positions("EPAC", "last") + scale_x_continuous( limits = c(-160,-80), expand = c(0,0) ) + scale_y_continuous( limits = c(5,45), expand = c(0,0) ) + theme_bw()
```

### Developing systems (EPAC)
```{r}
plot_positions("EPAC", "first", 33) + scale_x_continuous( limits = c(-160,-80), expand = c(0,0) ) + scale_y_continuous( limits = c(5,45), expand = c(0,0) ) + theme_bw()
plot_positions("EPAC", "last", 33) + scale_x_continuous( limits = c(-160,-80), expand = c(0,0) ) + scale_y_continuous( limits = c(5,45), expand = c(0,0) ) + theme_bw()
```

