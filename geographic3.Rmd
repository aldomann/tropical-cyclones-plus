---
title: "Análisis de la posición y distancia recorrida de los huracanes"
author: "Alfredo Hernández"
output:
  pdf_document: 
    fig_height: 3.5
    toc: yes
    toc_depth: 2
  html_document:
    df_print: paged
  html_notebook: 
    toc: yes
    toc_depth: 3
---

```{r message=FALSE, warning=FALSE, include=FALSE}
# Libraries ------------------------------------------------
library(measurements) # Convert units

# Source base code -----------------------------------------
source("geographic_base.R")
load("geographic_analysis.RData")
source("../libs/multiplot.R")
```

\newpage

# Análisis de la distancia (III)

```{r include=FALSE}
storms.tracks <- storms.all %>%
	dplyr::filter(n.obs > 1) %>% 
	group_by(storm.id) %>%
	# mutate(distance = distance_haversine(lat, lag(lat), long, lag(long))) %>%
	mutate(distance = distance_slc(lat, lag(lat), long, lag(long))) %>%
	mutate(distance = ifelse(is.na(distance), 0, distance)) %>%
	summarise(first.lat = first(lat), last.lat = last(lat),
						first.long = first(long), last.long = last(long),
						distance = sum(distance))
```

## Comentario sobre el cálculo de la distancia

Usando la fórmula de Haversine (vs la Ley de Cosenos), se obtiene en el peor de los casos una diferencia de 0.37 metros, y de media $10^{-8}$ metros. Pero bueno, en realidad no hay ninguna justificación para usar Haversine en lugar de la Ley de Cosenos (no con la precisión computacional de hoy en día).

## Mínimos y máximos de distancia recorrida y duración

### Todas las tormentas
```{r}
plot_distance_histogram("NATL") + theme_bw()
plot_distance_histogram("EPAC") + theme_bw()
```

### Developing systems
```{r}
plot_distance_histogram("NATL", 33) + theme_bw()
plot_distance_histogram("EPAC", 33) + theme_bw()
```

\newpage

# Análisis de posición inicial y final (III)

## North Atlantic

### Todas las tormentas (NATL)
```{r}
plot_positions_histogram("NATL", "first") + theme_bw()
plot_positions_histogram("NATL", "last") + theme_bw()
```

### Developing systems (NATL)
```{r}
plot_positions_histogram("NATL", "first", 33) + theme_bw()
plot_positions_histogram("NATL", "last", 33) + theme_bw()
```

\newpage

## East Pacific

### Todas las tormentas (EPAC)
```{r}
plot_positions_histogram("EPAC", "first") + theme_bw()
plot_positions_histogram("EPAC", "last") + theme_bw()
```

### Developing systems (EPAC)
```{r}
plot_positions_histogram("EPAC", "first", 33) + theme_bw()
plot_positions_histogram("EPAC", "last", 33) + theme_bw()
```


\newpage

## Mirando las medias

### Todas las tormentas
```{r}
get_location_mean_summary("NATL")
get_location_mean_summary("EPAC")
```

### Developing systems
```{r}
get_location_mean_summary("NATL", 33)
get_location_mean_summary("EPAC", 33)
```

## Mirando las medianas

### Todas las tormentas
```{r}
get_location_median_summary("NATL")
get_location_median_summary("EPAC")
```

### Developing systems
```{r}
get_location_median_summary("NATL", 33)
get_location_median_summary("EPAC", 33)
```


\newpage

# Análisis de posición inicial y final (IV): Boxplots and Wilcoxon Tests

## North Atlantic

### Todas las tormentas (NALT)
```{r}
plot_positions_boxplot("NATL", "first") + theme_bw()
perform_wilcox_test("first.lat", "NATL")
perform_wilcox_test("first.long", "NATL")
```

\newpage

### Developing systems (NALT)
```{r}
plot_positions_boxplot("NATL", "first", 33) + theme_bw()
perform_wilcox_test("first.lat", "NATL", 33)
perform_wilcox_test("first.long", "NATL", 33)
```

\newpage

## East Pacific

### Todas las tormentas (EPAC)
```{r}
plot_positions_boxplot("EPAC", "first") + theme_bw()
perform_wilcox_test("first.lat", "EPAC")
perform_wilcox_test("first.long", "EPAC")
```

\newpage

### Developing systems (EPAC)
```{r}
plot_positions_boxplot("EPAC", "first", 33) + theme_bw()
perform_wilcox_test("first.lat", "EPAC", 33)
perform_wilcox_test("first.long", "EPAC", 33)
```

\newpage

# Análisis de posición (V)

```{r}
plot_clusters <- function(basin.name, type, min.speed = 0, n.clust = 2) {
	storms.small <- storms.joint %>% 
		dplyr::filter(basin == basin.name) %>%
		dplyr::filter(max.wind > min.speed)
	
	if (type == "first") {
		mat <- storms.small %>% select(sst.class, first.lat, first.long, distance)
	} else if (type == "last") {
		mat <- storms.small %>% select(sst.class, last.lat, last.long, distance)
	}
	
	# High SST
	mat.high <- mat %>%
		dplyr::filter(sst.class == "high") %>% 
		select(-sst.class)
	clust.high <- hclust(dist(mat.high), method = "complete")
	tree.high <- cutree(clust.high, n.clust)
	
	# Low SST
	mat.low <- mat %>%
		dplyr::filter(sst.class == "low") %>% 
		select(-sst.class)
	clust.low <- hclust(dist(mat.low), method = "complete")
	tree.low <- cutree(clust.low, n.clust)
	
	# Merge data with clustering results
	data.high <- as_tibble(cbind(mat.high, clust = as.factor(tree.high), sst.class = "high"))
	data.low <- as_tibble(cbind(mat.low, clust = as.factor(tree.low), sst.class = "low"))
	data.all <- rbind(data.high, data.low)

	# Plot
	gg <- ggplot(data.all) +
		aes(colour = clust, size = distance) +
		scale_size_continuous(range = c(0.2, 3)) +
		facet_wrap( ~ sst.class)

	if (type == "first") {
		gg <- gg +
			geom_point(aes(x = first.long, y = first.lat), shape = 1)
	} else if (type == "last") {
		gg <- gg +
			geom_point(aes(x = last.long, y = last.lat), shape = 1)
	}

	return(gg)
}
```

\newpage

## North Atlantic
```{r}
plot_clusters("NATL", "first", 2)
plot_clusters("NATL", "last", 2)
```

\newpage
```{r}
plot_clusters("NATL", "first", 33, 2)
plot_clusters("NATL", "last", 33, 2)
```

\newpage

## East Pacific
```{r}
plot_clusters("EPAC", "first", 2)
plot_clusters("EPAC", "last", 2)
```

\newpage
```{r}
plot_clusters("EPAC", "first", 33, 2)
plot_clusters("EPAC", "last", 33, 2)
```


